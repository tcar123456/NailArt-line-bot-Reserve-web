# 📝 後台管理系統 - 設定與測試指南

## 🎯 概述

這份文件將引導您完成後台管理系統的設定，讓您可以透過圖形化介面管理美甲預約系統的服務項目、卸甲選項和延甲設定。

---

## 📋 步驟 1：建立 Google Sheets 工作表

### 1.1 開啟您的 Google Sheets

前往您現有的美甲預約系統 Google Sheets 文件。

### 1.2 新增工作表

1. 點擊左下角的「+」按鈕
2. 將新工作表命名為：**後台預約項目**（必須完全一致，包含中文字）

### 1.3 設定欄位標題

在第一行（Row 1）輸入以下標題：

| A列   | B列 | C列  | D列  | E列  | F列          |
|-------|-----|------|------|------|--------------|
| 類型  | ID  | 名稱 | 啟用 | 排序 | 最後修改時間 |

### 1.4 輸入初始資料（可選）

您可以先手動輸入一些初始資料，或者直接讓系統在第一次儲存時自動建立。

**範例資料：**

| 類型      | ID      | 名稱                              | 啟用  | 排序 | 最後修改時間        |
|-----------|---------|-----------------------------------|-------|------|---------------------|
| SERVICE   | 1       | 手｜單色                          | TRUE  | 1    | 2025-01-15 10:30:00 |
| SERVICE   | 2       | 手｜貓眼、鏡面、碎鑽特殊單色      | TRUE  | 2    | 2025-01-15 10:30:00 |
| SERVICE   | 3       | 手｜不挑款 or 其他 (麻煩備註...)  | TRUE  | 3    | 2025-01-15 10:30:00 |
| REMOVAL   | need    | 需要卸甲                          | TRUE  | 0    | 2025-01-15 10:30:00 |
| REMOVAL   | no-need | 不用卸甲                          | TRUE  | 0    | 2025-01-15 10:30:00 |
| EXTENSION | main    | 延甲功能                          | TRUE  | 0    | 2025-01-15 10:30:00 |
| QUANTITY  | 1-3     | 一到三隻                          | TRUE  | 1    | 2025-01-15 10:30:00 |
| QUANTITY  | 4-7     | 四到七隻                          | TRUE  | 2    | 2025-01-15 10:30:00 |
| QUANTITY  | 7+      | 七隻以上                          | TRUE  | 3    | 2025-01-15 10:30:00 |

---

## 📜 步驟 2：部署 Google Apps Script

### 2.1 開啟 Apps Script 編輯器

1. 在 Google Sheets 中，點擊「擴充功能」→「Apps Script」
2. 將 `rear-end-fire/google-apps-script.js` 的內容**完整複製**並貼到編輯器中
3. **重要：** 確保整個檔案都有複製（約 5500+ 行）

### 2.2 部署為網路應用程式

1. 點擊右上角「部署」→「新增部署」
2. 選擇類型：「網路應用程式」
3. 設定：
   - **描述**：美甲預約系統後台管理 API
   - **執行身分**：我
   - **具有應用程式存取權的使用者**：任何人
4. 點擊「部署」
5. **複製網路應用程式的網址**（稍後會用到）

### 2.3 授權應用程式

第一次部署時，Google 會要求您授權。請按照指示完成授權。

---

## 🔗 步驟 3：更新 API 網址

### 3.1 編輯 api-service.js

開啟 `api-service.js` 檔案，找到第 7 行：

```javascript
const SCRIPT_URL = 'https://script.google.com/macros/s/YOUR_DEPLOYMENT_URL/exec';
```

### 3.2 替換網址

將 `YOUR_DEPLOYMENT_URL` 替換為您在步驟 2.2 複製的網路應用程式網址。

**範例：**
```javascript
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX/exec';
```

---

## 🧪 步驟 4：測試後台管理系統

### 4.1 開啟後台管理頁面

在瀏覽器中開啟 `admin.html`

**本地測試方法：**
```
file:///C:/Users/User/Desktop/work/LINE-bot/Nail-Art-line-bot/Reserve-web/admin.html
```

或使用本地伺服器：
```bash
# 在專案目錄執行
python -m http.server 8000

# 然後開啟
http://localhost:8000/admin.html
```

### 4.2 測試流程

#### ✅ 測試 1：檢視模式
1. 頁面應該顯示所有服務項目、卸甲選項和延甲設定
2. 所有項目應該是唯讀模式（不可編輯）
3. 只有「修改」按鈕可見

#### ✅ 測試 2：進入編輯模式
1. 點擊「修改」按鈕
2. 應該看到：
   - 所有項目變成可編輯（顯示輸入框）
   - 每個項目都有「啟用」開關
   - 每個項目都有「×」刪除按鈕
   - 出現「送出」和「放棄修改」按鈕
   - 出現「+ 新增服務項目」按鈕
   - 出現拖拽提示：「長按拖曳改變項目順序」

#### ✅ 測試 3：編輯功能
1. **修改名稱**：點擊任何輸入框並修改文字
2. **啟用/停用**：切換開關，項目應該變灰並顯示刪除線
3. **拖拽排序**（桌面版）：
   - 長按服務項目
   - 拖動到新位置
   - 放開滑鼠，項目應該移動到新位置
4. **新增項目**：
   - 點擊「+ 新增服務項目」
   - 應該出現新的可編輯項目
   - 輸入框自動聚焦
5. **刪除項目**：
   - 點擊任何項目的「×」按鈕
   - 項目應該以動畫方式消失

#### ✅ 測試 4：延甲功能控制
1. 找到「延甲功能」項目
2. 切換其開關為「關閉」
3. 「數量選項」區域應該立即隱藏
4. 切換回「開啟」
5. 「數量選項」區域應該重新顯示
6. 點擊「+ 新增數量選項」可以新增自訂選項

#### ✅ 測試 5：取消修改
1. 進行一些修改（不要送出）
2. 點擊「放棄修改」按鈕
3. 所有修改應該被復原到原始狀態
4. 返回檢視模式

#### ✅ 測試 6：儲存到 Google Sheets
1. 進入編輯模式
2. 進行一些修改：
   - 修改「手｜單色」為「手部｜基礎單色」
   - 新增一個服務項目「手｜漸層」
   - 關閉「需要卸甲」選項
   - 新增延甲數量選項「八隻以上」
3. 點擊「送出」按鈕
4. 點擊「確認」
5. 觀察：
   - 按鈕文字變成「儲存中...」
   - 按鈕變成不可點擊
   - 稍後出現「✅ 設定已成功儲存到 Google Sheets！」訊息
6. **重要：開啟您的 Google Sheets 查看**
   - 前往「後台預約項目」工作表
   - 確認所有修改都已同步
   - 檢查「最後修改時間」欄位是否更新

### 4.3 驗證資料正確性

在 Google Sheets 中檢查：

1. **服務項目**（TYPE = SERVICE）
   - 名稱是否正確
   - 啟用狀態是否正確（TRUE/FALSE）
   - 排序順序是否正確（1, 2, 3...）

2. **卸甲選項**（TYPE = REMOVAL）
   - 兩個選項都存在
   - 啟用狀態正確

3. **延甲設定**（TYPE = EXTENSION, QUANTITY）
   - 延甲功能開關狀態正確
   - 所有數量選項都正確儲存
   - 包含您新增的自訂選項

---

## 🐛 常見問題排解

### 問題 1：點擊「送出」後沒有反應

**可能原因：**
- API 網址未正確設定
- Google Apps Script 未正確部署
- 網路連線問題

**解決方法：**
1. 開啟瀏覽器開發者工具（F12）
2. 查看 Console 分頁
3. 檢查是否有錯誤訊息
4. 確認 `api-service.js` 中的 SCRIPT_URL 正確

### 問題 2：出現 CORS 錯誤

**解決方法：**
- 確保使用 HTTP/HTTPS 協議開啟頁面（不要用 file://）
- 使用本地伺服器或部署到網路主機

### 問題 3：Google Sheets 沒有更新

**檢查項目：**
1. Apps Script 是否正確部署
2. 是否有授權應用程式
3. 工作表名稱是否完全正確（「後台預約項目」）
4. 開啟 Google Apps Script 編輯器 → 執行 → 查看日誌

### 問題 4：拖拽功能無法使用（手機）

**這是正常的：**
- 手機上需要「長按 100ms 且不移動」才會啟動拖拽
- 如果太快移動會被判定為滾動操作
- 桌面版體驗較佳

---

## 📊 資料格式說明

### 類型欄位（TYPE）

| 類型      | 說明           | 排序 |
|-----------|----------------|------|
| SERVICE   | 服務項目       | 必填 |
| REMOVAL   | 卸甲選項       | 0    |
| EXTENSION | 延甲功能開關   | 0    |
| QUANTITY  | 延甲數量選項   | 必填 |

### 啟用欄位（Enabled）

- `TRUE` 或 `true`：啟用（顯示給客戶）
- `FALSE` 或 `false`：停用（不顯示）

### 排序欄位（Sort）

- 服務項目：1, 2, 3...（依照顯示順序）
- 延甲數量選項：1, 2, 3...（依照顯示順序）
- 其他：0（不需要排序）

---

## 🎉 完成！

恭喜您已經完成後台管理系統的設定！

現在您可以：
- ✅ 透過圖形化介面管理所有服務項目
- ✅ 即時啟用/停用選項
- ✅ 拖拽排序
- ✅ 新增自訂項目
- ✅ 所有變更自動同步到 Google Sheets

---

## 📞 下一步

完成後台設定後，下一步是讓 `service-selection.html`（前台客戶端）從 Google Sheets 讀取這些設定並動態生成服務選項。

這將在後續實作中進行整合。

---

## 📝 技術細節

### API 端點

- `updateAdminSettings`：更新後台設定
- `getAdminSettings`：讀取後台設定

### 檔案結構

```
Reserve-web/
├── admin.html              (後台管理介面)
├── admin.css               (後台樣式)
├── admin.js                (後台邏輯)
├── api-service.js          (API 通訊)
├── csrf-protection.js      (安全保護)
├── security-utils.js       (安全工具)
├── crypto-utils.js         (加密工具)
└── rear-end-fire/
    └── google-apps-script.js  (後端 API)
```

### 資料流程

```
使用者編輯
    ↓
admin.js 收集資料
    ↓
api-service.js 發送請求
    ↓
Google Apps Script API
    ↓
Google Sheets 更新
```

---

**版本：** 1.0
**最後更新：** 2025-01-15

